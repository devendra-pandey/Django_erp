{% extends 'base.html' %}

{% block title %}
    {% if object %}
        Edit Purchase Order - {{ object.po_number }}
    {% else %}
        Create New Purchase Order
    {% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-{% if object %}edit{% else %}plus-circle{% endif %}"></i>
                        {% if object %}
                            Edit Purchase Order: {{ object.po_number }}
                        {% else %}
                            Create New Purchase Order
                        {% endif %}
                    </h4>
                </div>
                
                <div class="card-body">
                    <form method="post" id="po-form">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>Please correct the errors below:</strong>
                            <ul>
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>{{ field }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Basic Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.supplier.id_for_label }}" class="form-label">
                                                Supplier <span class="text-danger">*</span>
                                            </label>
                                            {{ form.supplier }}
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="{{ form.order_date.id_for_label }}" class="form-label">
                                                        Order Date <span class="text-danger">*</span>
                                                    </label>
                                                    {{ form.order_date }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="{{ form.expected_delivery.id_for_label }}" class="form-label">
                                                        Expected Delivery <span class="text-danger">*</span>
                                                    </label>
                                                    {{ form.expected_delivery }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                                Status
                                            </label>
                                            {{ form.status }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Delivery Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.delivery_address.id_for_label }}" class="form-label">
                                                Delivery Address <span class="text-danger">*</span>
                                            </label>
                                            {{ form.delivery_address }}
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.terms_conditions.id_for_label }}" class="form-label">
                                                Terms & Conditions
                                            </label>
                                            {{ form.terms_conditions }}
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                                Notes
                                            </label>
                                            {{ form.notes }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PO Items -->
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Order Items</h6>
                                <button type="button" class="btn btn-sm btn-success" id="add-item">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                            <div class="card-body">
                                {{ formset.management_form }}
                                <div id="items-formset">
                                    {% if object %}
                                        <!-- Update mode: Show all existing items -->
                                        {% for item_form in formset %}
                                            {% if not forloop.last or forloop.last and formset|length == 1 %}
                                            <div class="item-form card mb-2">
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <div class="form-group">
                                                                <label>Product</label>
                                                                {{ item_form.product }}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="form-group">
                                                                <label>Quantity</label>
                                                                {{ item_form.quantity }}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="form-group">
                                                                <label>Unit Price</label>
                                                                {{ item_form.unit_price }}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="form-group">
                                                                <label>Tax Rate (%)</label>
                                                                {{ item_form.tax_rate }}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="form-group">
                                                                <label>Warehouse</label>
                                                                {{ item_form.warehouse }}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-1 d-flex align-items-end">
                                                            {% if item_form.DELETE %}
                                                            <div class="form-group">
                                                                <label class="text-danger">Delete</label>
                                                                {{ item_form.DELETE }}
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    {{ item_form.id }}
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="form-group mb-0">
                                                                <small class="text-muted">
                                                                    <span class="subtotal">Subtotal: $0.00</span> | 
                                                                    <span class="tax">Tax: $0.00</span> | 
                                                                    <span class="total">Total: $0.00</span>
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <!-- Create mode: Show only one empty row -->
                                        {% for item_form in formset %}
                                            {% if forloop.first %}
                                            <div class="item-form card mb-2">
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <div class="form-group">
                                                                <label>Product <span class="text-danger">*</span></label>
                                                                {{ item_form.product }}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="form-group">
                                                                <label>Quantity <span class="text-danger">*</span></label>
                                                                {{ item_form.quantity }}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="form-group">
                                                                <label>Unit Price <span class="text-danger">*</span></label>
                                                                {{ item_form.unit_price }}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="form-group">
                                                                <label>Tax Rate (%)</label>
                                                                {{ item_form.tax_rate }}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="form-group">
                                                                <label>Warehouse</label>
                                                                {{ item_form.warehouse }}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-1 d-flex align-items-end">
                                                            {% if not forloop.first and item_form.DELETE %}
                                                            <div class="form-group">
                                                                <label class="text-danger">Delete</label>
                                                                {{ item_form.DELETE }}
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    {{ item_form.id }}
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="form-group mb-0">
                                                                <small class="text-muted">
                                                                    <span class="subtotal">Subtotal: $0.00</span> | 
                                                                    <span class="tax">Tax: $0.00</span> | 
                                                                    <span class="total">Total: $0.00</span>
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                
                                <!-- Totals -->
                                <div class="row mt-4">
                                    <div class="col-md-6 offset-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Subtotal:</span>
                                                    <strong id="total-subtotal">$0.00</strong>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Tax:</span>
                                                    <strong id="total-tax">$0.00</strong>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Grand Total:</span>
                                                    <strong id="total-grand">$0.00</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="form-group">
                            <div class="btn-group" role="group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    {% if object %}
                                        Update Purchase Order
                                    {% else %}
                                        Create Purchase Order
                                    {% endif %}
                                </button>
                                <a href="{% url 'procurement:purchase_order_list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                {% if object %}
                                <a href="{% url 'procurement:purchase_order_detail' object.pk %}" class="btn btn-info">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-control {
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 0.9rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

select.form-control {
    height: calc(2.25rem + 2px);
}

textarea.form-control {
    min-height: 80px;
}

.item-form {
    border-left: 4px solid #007bff;
}

.delete-checkbox {
    margin-top: 28px;
}

.delete-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply Bootstrap classes
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.classList.add('form-control');
    });
    
    // Style the delete checkbox
    document.querySelectorAll('input[name$="-DELETE"]').forEach(checkbox => {
        const label = checkbox.closest('.form-group').querySelector('label');
        if (label) {
            label.style.display = 'block';
            label.style.marginBottom = '5px';
        }
        checkbox.style.width = '20px';
        checkbox.style.height = '20px';
        checkbox.style.marginTop = '10px';
    });
    
    // Calculate item totals
    function calculateItemTotal(form) {
        const quantity = parseFloat(form.querySelector('[id$="-quantity"]').value) || 0;
        const unitPrice = parseFloat(form.querySelector('[id$="-unit_price"]').value) || 0;
        const taxRate = parseFloat(form.querySelector('[id$="-tax_rate"]').value) || 0;
        
        const subtotal = quantity * unitPrice;
        const tax = subtotal * (taxRate / 100);
        const total = subtotal + tax;
        
        const subtotalEl = form.querySelector('.subtotal');
        const taxEl = form.querySelector('.tax');
        const totalEl = form.querySelector('.total');
        
        if (subtotalEl) subtotalEl.textContent = `Subtotal: $${subtotal.toFixed(2)}`;
        if (taxEl) taxEl.textContent = `Tax: $${tax.toFixed(2)}`;
        if (totalEl) totalEl.textContent = `Total: $${total.toFixed(2)}`;
        
        return { subtotal, tax, total };
    }
    
    // Calculate all totals
    function calculateAllTotals() {
        let totalSubtotal = 0;
        let totalTax = 0;
        let totalGrand = 0;
        
        document.querySelectorAll('.item-form').forEach(form => {
            const totals = calculateItemTotal(form);
            totalSubtotal += totals.subtotal;
            totalTax += totals.tax;
            totalGrand += totals.total;
        });
        
        document.getElementById('total-subtotal').textContent = `$${totalSubtotal.toFixed(2)}`;
        document.getElementById('total-tax').textContent = `$${totalTax.toFixed(2)}`;
        document.getElementById('total-grand').textContent = `$${totalGrand.toFixed(2)}`;
    }
    
    // Get empty form template
    function getEmptyFormTemplate(formNum) {
        const firstForm = document.querySelector('.item-form');
        if (!firstForm) return null;
        
        const newForm = firstForm.cloneNode(true);
        
        // Update IDs and names
        newForm.querySelectorAll('input, select').forEach(input => {
            const nameMatch = input.name.match(/-\d+-/);
            if (nameMatch) {
                const name = input.name.replace(/-\d+-/, `-${formNum}-`);
                const id = input.id.replace(/-\d+-/, `-${formNum}-`);
                input.name = name;
                input.id = id;
                input.value = '';
            }
        });
        
        newForm.querySelectorAll('label').forEach(label => {
            const forAttr = label.getAttribute('for');
            if (forAttr) {
                const forMatch = forAttr.match(/-\d+-/);
                if (forMatch) {
                    label.setAttribute('for', forAttr.replace(/-\d+-/, `-${formNum}-`));
                }
            }
        });
        
        // Clear values
        newForm.querySelectorAll('input[type="text"], input[type="number"], select').forEach(input => {
            if (!input.name.includes('DELETE') && !input.name.includes('id')) {
                input.value = '';
                if (input.name.includes('tax_rate')) {
                    input.value = '0'; // Default tax rate
                }
            }
        });
        
        // Remove ID field if it exists (for new items)
        const idInput = newForm.querySelector('input[name$="-id"]');
        if (idInput) {
            idInput.remove();
        }
        
        return newForm;
    }
    
    // Add item form
    document.getElementById('add-item').addEventListener('click', function() {
        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
        const formNum = parseInt(totalForms.value);
        const formset = document.getElementById('items-formset');
        
        const newForm = getEmptyFormTemplate(formNum);
        if (newForm) {
            // Add delete checkbox for new rows (except first)
            if (formNum > 0) {
                const deleteDiv = document.createElement('div');
                deleteDiv.className = 'col-md-1 d-flex align-items-end delete-checkbox';
                deleteDiv.innerHTML = `
                    <div class="form-group">
                        <label class="text-danger">Delete</label>
                        <input type="checkbox" name="items-${formNum}-DELETE" id="id_items-${formNum}-DELETE" class="form-control">
                    </div>
                `;
                
                // Find the row and replace last column with delete checkbox
                const row = newForm.querySelector('.row');
                const cols = row.querySelectorAll('.col-md-1');
                if (cols.length > 0) {
                    row.replaceChild(deleteDiv, cols[cols.length - 1]);
                }
            }
            
            formset.appendChild(newForm);
            totalForms.value = formNum + 1;
            
            // Reapply Bootstrap classes
            newForm.querySelectorAll('input, select').forEach(input => {
                input.classList.add('form-control');
            });
            
            // Recalculate totals
            calculateAllTotals();
        }
    });
    
    // Auto-calculate on input
    document.addEventListener('input', function(e) {
        if (e.target.matches('[id$="-quantity"], [id$="-unit_price"], [id$="-tax_rate"]')) {
            const form = e.target.closest('.item-form');
            if (form) {
                calculateItemTotal(form);
                calculateAllTotals();
            }
        }
    });
    
    // Initial calculation
    calculateAllTotals();
    
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    const weekLater = new Date();
    weekLater.setDate(weekLater.getDate() + 7);
    const weekLaterStr = weekLater.toISOString().split('T')[0];
    
    const orderDate = document.getElementById('id_order_date');
    const expectedDelivery = document.getElementById('id_expected_delivery');
    
    if (orderDate && !orderDate.value) orderDate.value = today;
    if (expectedDelivery && !expectedDelivery.value) expectedDelivery.value = weekLaterStr;
    
    // Handle form validation - ensure at least one item
    document.getElementById('po-form').addEventListener('submit', function(e) {
        let hasValidItem = false;
        document.querySelectorAll('.item-form').forEach(form => {
            const quantity = form.querySelector('[id$="-quantity"]').value;
            const unitPrice = form.querySelector('[id$="-unit_price"]').value;
            const product = form.querySelector('[id$="-product"]').value;
            
            if (quantity && unitPrice && product) {
                hasValidItem = true;
            }
        });
        
        if (!hasValidItem) {
            e.preventDefault();
            alert('Please add at least one item with product, quantity, and unit price.');
        }
    });
});
</script>
{% endblock %}