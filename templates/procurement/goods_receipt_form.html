{% extends 'base.html' %}

{% block title %}
    {% if object %}
        Edit Goods Receipt - {{ object.gr_number }}
    {% else %}
        Create Goods Receipt
    {% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-{% if object %}edit{% else %}plus-circle{% endif %}"></i>
                        {% if object %}
                            Edit Goods Receipt: {{ object.gr_number }}
                        {% else %}
                            Create Goods Receipt
                        {% endif %}
                    </h4>
                </div>
                
                <div class="card-body">
                    <form method="post" id="gr-form">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>Please correct the errors below:</strong>
                            <ul>
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>{{ field }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Basic Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.purchase_order.id_for_label }}" class="form-label">
                                                Purchase Order <span class="text-danger">*</span>
                                            </label>
                                            {{ form.purchase_order }}
                                            <div class="form-text">
                                                Select a purchase order to receive goods against
                                            </div>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.receipt_date.id_for_label }}" class="form-label">
                                                Receipt Date <span class="text-danger">*</span>
                                            </label>
                                            {{ form.receipt_date }}
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.warehouse.id_for_label }}" class="form-label">
                                                Warehouse <span class="text-danger">*</span>
                                            </label>
                                            {{ form.warehouse }}
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.received_by.id_for_label }}" class="form-label">
                                                Received By <span class="text-danger">*</span>
                                            </label>
                                            {{ form.received_by }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Additional Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                                Notes
                                            </label>
                                            {{ form.notes }}
                                            <div class="form-text">
                                                Enter any additional notes about this receipt
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- PO Information Card -->
                                <div class="card mt-3" id="po-info-card" style="display: none;">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">Purchase Order Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="po-info-content">
                                            <!-- PO info will be loaded here via AJAX -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PO Items for Receipt -->
                        <div class="card mb-4" id="po-items-card" style="display: none;">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Items to Receive</h6>
                            </div>
                            <div class="card-body">
                                <div id="po-items-content">
                                    <!-- PO items will be loaded here via AJAX -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="form-group">
                            <div class="btn-group" role="group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    {% if object %}
                                        Update Goods Receipt
                                    {% else %}
                                        Create Goods Receipt
                                    {% endif %}
                                </button>
                                <a href="{% url 'procurement:goods_receipt_list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-control {
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 0.9rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

select.form-control {
    height: calc(2.25rem + 2px);
}

textarea.form-control {
    min-height: 80px;
}

.item-row {
    border-bottom: 1px solid #dee2e6;
    padding: 10px 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply Bootstrap classes
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.classList.add('form-control');
    });
    
    // Set default date
    const today = new Date().toISOString().split('T')[0];
    const receiptDate = document.getElementById('id_receipt_date');
    if (receiptDate && !receiptDate.value) receiptDate.value = today;
    
    // Auto-select current user
    const receivedBy = document.getElementById('id_received_by');
    if (receivedBy) {
        // You would need to pass the current user ID to the template
        // For now, we'll leave it empty
    }
    
    // Load PO information when selected
    const poSelect = document.getElementById('id_purchase_order');
    if (poSelect) {
        poSelect.addEventListener('change', function() {
            const poId = this.value;
            if (poId) {
                // Show loading
                document.getElementById('po-info-card').style.display = 'block';
                document.getElementById('po-info-content').innerHTML = '<p>Loading...</p>';
                
                document.getElementById('po-items-card').style.display = 'block';
                document.getElementById('po-items-content').innerHTML = '<p>Loading items...</p>';
                
                // Load PO info
                fetch(`/procurement/api/get-po-items/${poId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            // Update PO info
                            const poInfo = `
                                <table class="table table-sm">
                                    <tr>
                                        <th>PO Number:</th>
                                        <td>${data[0].po_number || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <th>Supplier:</th>
                                        <td>${data[0].supplier || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <th>Order Date:</th>
                                        <td>${data[0].order_date || 'N/A'}</td>
                                    </tr>
                                </table>
                            `;
                            document.getElementById('po-info-content').innerHTML = poInfo;
                            
                            // Create items table
                            let itemsHTML = `
                                <table class="table table-bordered">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Product</th>
                                            <th>Ordered</th>
                                            <th>Received</th>
                                            <th>Pending</th>
                                            <th>Quantity to Receive</th>
                                            <th>Batch Number</th>
                                            <th>Expiry Date</th>
                                            <th>Quality Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            data.forEach(item => {
                                itemsHTML += `
                                    <tr>
                                        <td>${item.product}</td>
                                        <td class="text-right">${item.ordered} ${item.unit}</td>
                                        <td class="text-right">${item.received} ${item.unit}</td>
                                        <td class="text-right">${item.pending} ${item.unit}</td>
                                        <td>
                                            <input type="number" name="quantity_${item.id}" 
                                                   class="form-control" step="0.001" 
                                                   min="0" max="${item.pending}" 
                                                   value="${item.pending}">
                                        </td>
                                        <td>
                                            <input type="text" name="batch_${item.id}" 
                                                   class="form-control" placeholder="Enter batch no">
                                        </td>
                                        <td>
                                            <input type="date" name="expiry_${item.id}" 
                                                   class="form-control">
                                        </td>
                                        <td>
                                            <select name="quality_${item.id}" class="form-control">
                                                <option value="pending">Pending QC</option>
                                                <option value="passed">Passed</option>
                                                <option value="rejected">Rejected</option>
                                                <option value="quarantine">Quarantine</option>
                                            </select>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            itemsHTML += `
                                    </tbody>
                                </table>
                                <input type="hidden" name="po_id" value="${poId}">
                            `;
                            
                            document.getElementById('po-items-content').innerHTML = itemsHTML;
                        } else {
                            document.getElementById('po-info-content').innerHTML = '<p class="text-warning">No pending items found for this PO</p>';
                            document.getElementById('po-items-content').innerHTML = '<p class="text-warning">All items have been received</p>';
                        }
                    })
                    .catch(error => {
                        document.getElementById('po-info-content').innerHTML = '<p class="text-danger">Error loading PO information</p>';
                        document.getElementById('po-items-content').innerHTML = '<p class="text-danger">Error loading items</p>';
                    });
            } else {
                document.getElementById('po-info-card').style.display = 'none';
                document.getElementById('po-items-card').style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}