{% extends 'base.html' %}

{% block title %}
    {% if object %}
        Edit Production Order - {{ object.order_number }}
    {% else %}
        Create Production Order
    {% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-{% if object %}edit{% else %}plus-circle{% endif %}"></i>
                        {% if object %}
                            Edit Production Order: {{ object.order_number }}
                        {% else %}
                            Create Production Order
                        {% endif %}
                    </h4>
                </div>
                
                <div class="card-body">
                    <form method="post" id="production-order-form">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>Please correct the errors below:</strong>
                            <ul>
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>{{ field }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Order Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.bom.id_for_label }}" class="form-label">
                                                Bill of Materials (BOM) <span class="text-danger">*</span>
                                            </label>
                                            {{ form.bom }}
                                            <div class="form-text">
                                                Select the BOM to use for production
                                            </div>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.product.id_for_label }}" class="form-label">
                                                Product <span class="text-danger">*</span>
                                            </label>
                                            {{ form.product }}
                                            <div class="form-text">
                                                Product to be manufactured
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="{{ form.quantity.id_for_label }}" class="form-label">
                                                        Quantity <span class="text-danger">*</span>
                                                    </label>
                                                    {{ form.quantity }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="{{ form.uom.id_for_label }}" class="form-label">
                                                        Unit of Measure <span class="text-danger">*</span>
                                                    </label>
                                                    {{ form.uom }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.priority.id_for_label }}" class="form-label">
                                                Priority
                                            </label>
                                            {{ form.priority }}
                                            <div class="form-text">
                                                1 = Highest, 10 = Lowest
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Scheduling</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="{{ form.planned_start.id_for_label }}" class="form-label">
                                                        Planned Start <span class="text-danger">*</span>
                                                    </label>
                                                    {{ form.planned_start }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="{{ form.planned_end.id_for_label }}" class="form-label">
                                                        Planned End <span class="text-danger">*</span>
                                                    </label>
                                                    {{ form.planned_end }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.work_center.id_for_label }}" class="form-label">
                                                Work Center
                                            </label>
                                            {{ form.work_center }}
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.supervisor.id_for_label }}" class="form-label">
                                                Supervisor
                                            </label>
                                            {{ form.supervisor }}
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                                Status
                                            </label>
                                            {{ form.status }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BOM Information Card -->
                        <div class="card mb-4" id="bom-info-card" style="display: none;">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Bill of Materials Information</h6>
                            </div>
                            <div class="card-body">
                                <div id="bom-info-content">
                                    <!-- BOM info will be loaded here via AJAX -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Material Requirements -->
                        <div class="card mb-4" id="material-requirements-card" style="display: none;">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0">Material Requirements</h6>
                            </div>
                            <div class="card-body">
                                <div id="material-requirements-content">
                                    <!-- Material requirements will be loaded here via AJAX -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Additional Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label">
                                        Notes
                                    </label>
                                    {{ form.notes }}
                                    <div class="form-text">
                                        Enter any special instructions or notes for this production order
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cost Estimation -->
                        <div class="card mb-4" id="cost-estimation-card" style="display: none;">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">Cost Estimation</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label">Estimated Material Cost</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="text" id="estimated_material_cost" 
                                                       class="form-control" readonly value="0.00">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label">Estimated Production Cost</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="text" id="estimated_production_cost" 
                                                       class="form-control" readonly value="0.00">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label">Total Estimated Cost</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="text" id="total_estimated_cost" 
                                                       class="form-control font-weight-bold" 
                                                       readonly value="0.00">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="form-group">
                            <div class="btn-group" role="group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    {% if object %}
                                        Update Production Order
                                    {% else %}
                                        Create Production Order
                                    {% endif %}
                                </button>
                                <a href="{% url 'production:order_list'|default:'#' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                {% if object %}
                                <a href="{% url 'production:order_detail' object.pk %}" class="btn btn-info">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-control {
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 0.9rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

select.form-control {
    height: calc(2.25rem + 2px);
}

textarea.form-control {
    min-height: 80px;
}

.material-item {
    border-bottom: 1px solid #dee2e6;
    padding: 8px 0;
}

.material-item:last-child {
    border-bottom: none;
}

.availability-good {
    color: #28a745;
}

.availability-warning {
    color: #ffc107;
}

.availability-danger {
    color: #dc3545;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply Bootstrap classes
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.type !== 'checkbox' && input.type !== 'radio') {
            input.classList.add('form-control');
        }
    });
    
    // Set default dates
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const plannedStart = document.getElementById('id_planned_start');
    const plannedEnd = document.getElementById('id_planned_end');
    
    if (plannedStart && !plannedStart.value) {
        plannedStart.value = today.toISOString().slice(0, 16);
    }
    
    if (plannedEnd && !plannedEnd.value) {
        // Default end time: start + 8 hours
        const endTime = new Date(today);
        endTime.setHours(endTime.getHours() + 8);
        plannedEnd.value = endTime.toISOString().slice(0, 16);
    }
    
    // Load BOM information when selected
    const bomSelect = document.getElementById('id_bom');
    if (bomSelect) {
        bomSelect.addEventListener('change', function() {
            const bomId = this.value;
            if (bomId) {
                // Show loading
                document.getElementById('bom-info-card').style.display = 'block';
                document.getElementById('bom-info-content').innerHTML = '<p>Loading BOM information...</p>';
                
                document.getElementById('material-requirements-card').style.display = 'block';
                document.getElementById('material-requirements-content').innerHTML = '<p>Loading material requirements...</p>';
                
                document.getElementById('cost-estimation-card').style.display = 'block';
                
                // Load BOM info via AJAX
                fetch(`/production/api/get-bom-details/${bomId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update BOM info
                            const bomInfo = `
                                <div class="row">
                                    <div class="col-md-4">
                                        <p><strong>BOM Code:</strong> ${data.bom.code}</p>
                                        <p><strong>Version:</strong> ${data.bom.version}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>Production Time:</strong> ${data.bom.production_time} hours/unit</p>
                                        <p><strong>Scrap Rate:</strong> ${data.bom.scrap_rate}%</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>Finished Product:</strong> ${data.bom.finished_product}</p>
                                        <p><strong>Status:</strong> ${data.bom.is_active ? 'Active' : 'Inactive'}</p>
                                    </div>
                                </div>
                            `;
                            document.getElementById('bom-info-content').innerHTML = bomInfo;
                            
                            // Calculate total production time
                            const quantity = parseFloat(document.getElementById('id_quantity').value) || 0;
                            const totalTime = data.bom.production_time * quantity;
                            if (totalTime > 0 && plannedStart && plannedEnd) {
                                const startTime = new Date(plannedStart.value);
                                const endTime = new Date(startTime);
                                endTime.setHours(endTime.getHours() + totalTime);
                                plannedEnd.value = endTime.toISOString().slice(0, 16);
                            }
                            
                            // Load material requirements
                            if (data.materials && data.materials.length > 0) {
                                let materialsHTML = `
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-sm">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th>Component</th>
                                                    <th>SKU</th>
                                                    <th>Required Qty</th>
                                                    <th>Unit</th>
                                                    <th>Stock Available</th>
                                                    <th>Status</th>
                                                    <th>Estimated Cost</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                `;
                                
                                let totalMaterialCost = 0;
                                
                                data.materials.forEach(material => {
                                    const requiredQty = material.quantity * quantity;
                                    const availableQty = material.stock || 0;
                                    let status = 'Sufficient';
                                    let statusClass = 'availability-good';
                                    
                                    if (availableQty < requiredQty) {
                                        status = 'Insufficient';
                                        statusClass = 'availability-danger';
                                    } else if (availableQty < requiredQty * 1.1) {
                                        status = 'Low';
                                        statusClass = 'availability-warning';
                                    }
                                    
                                    const materialCost = requiredQty * (material.unit_cost || 0);
                                    totalMaterialCost += materialCost;
                                    
                                    materialsHTML += `
                                        <tr>
                                            <td>${material.name}</td>
                                            <td>${material.sku}</td>
                                            <td class="text-right">${requiredQty.toFixed(3)}</td>
                                            <td>${material.uom}</td>
                                            <td class="text-right">${availableQty.toFixed(3)}</td>
                                            <td class="${statusClass}">${status}</td>
                                            <td class="text-right">$${materialCost.toFixed(2)}</td>
                                        </tr>
                                    `;
                                });
                                
                                materialsHTML += `
                                        </tbody>
                                        <tfoot class="font-weight-bold">
                                            <tr>
                                                <td colspan="6" class="text-right">Total Material Cost:</td>
                                                <td class="text-right">$${totalMaterialCost.toFixed(2)}</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                `;
                                
                                document.getElementById('material-requirements-content').innerHTML = materialsHTML;
                                
                                // Update cost estimation
                                const productionCost = totalTime * (data.bom.production_cost_per_hour || 50);
                                const totalCost = totalMaterialCost + productionCost;
                                
                                document.getElementById('estimated_material_cost').value = totalMaterialCost.toFixed(2);
                                document.getElementById('estimated_production_cost').value = productionCost.toFixed(2);
                                document.getElementById('total_estimated_cost').value = totalCost.toFixed(2);
                            }
                        } else {
                            document.getElementById('bom-info-content').innerHTML = '<p class="text-danger">Error loading BOM information</p>';
                            document.getElementById('material-requirements-content').innerHTML = '<p class="text-danger">Error loading material requirements</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('bom-info-content').innerHTML = '<p class="text-danger">Error loading BOM information</p>';
                        document.getElementById('material-requirements-content').innerHTML = '<p class="text-danger">Error loading material requirements</p>';
                    });
            } else {
                document.getElementById('bom-info-card').style.display = 'none';
                document.getElementById('material-requirements-card').style.display = 'none';
                document.getElementById('cost-estimation-card').style.display = 'none';
            }
        });
    }
    
    // Auto-update when quantity changes
    const quantityInput = document.getElementById('id_quantity');
    if (quantityInput) {
        quantityInput.addEventListener('input', function() {
            // Trigger BOM change event to recalculate
            if (bomSelect && bomSelect.value) {
                bomSelect.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // Auto-populate product based on BOM selection
    const productSelect = document.getElementById('id_product');
    if (bomSelect && productSelect) {
        bomSelect.addEventListener('change', function() {
            const bomId = this.value;
            if (bomId) {
                // This would typically be done via AJAX
                // For now, we'll just trigger a change
            }
        });
    }
    
    // Form validation
    const form = document.getElementById('production-order-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const bom = document.getElementById('id_bom');
            const quantity = document.getElementById('id_quantity');
            const plannedStart = document.getElementById('id_planned_start');
            const plannedEnd = document.getElementById('id_planned_end');
            
            if (!bom.value) {
                e.preventDefault();
                alert('Please select a Bill of Materials');
                bom.focus();
                return false;
            }
            
            if (!quantity.value || parseFloat(quantity.value) <= 0) {
                e.preventDefault();
                alert('Please enter a valid quantity (greater than 0)');
                quantity.focus();
                return false;
            }
            
            if (!plannedStart.value || !plannedEnd.value) {
                e.preventDefault();
                alert('Please enter both planned start and end times');
                return false;
            }
            
            const startTime = new Date(plannedStart.value);
            const endTime = new Date(plannedEnd.value);
            
            if (endTime <= startTime) {
                e.preventDefault();
                alert('Planned end time must be after start time');
                return false;
            }
            
            return true;
        });
    }
});
</script>
{% endblock %}